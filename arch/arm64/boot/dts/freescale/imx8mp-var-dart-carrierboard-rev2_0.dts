// SPDX-License-Identifier: (GPL-2.0+ OR MIT)
/*
 * Copyright 2019 NXP
 * Copyright 2020-2021 Variscite Ltd.
 */
#include <dt-bindings/input/ti-drv260x.h>

#include "imx8mp-var-dart.dtsi"

/ {
	model = "Variscite DART-MX8M-PLUS on Magnosco Carrier Board v1.1";

	aliases {
		display0 = &mipi_panel;
		display1 = &lvds_panel;
	};

	chosen {
		stdout-path = &uart1;
	};

	boost_conv_5V: boost_converter_5V {
		compatible = "regulator-gpio";

		regulator-name = "BOOST_CONV_5V";
		regulator-type = "voltage";
		regulator-min-microvolt = <5000000>;
		regulator-max-microvolt = <5000000>;

		enable-gpios = <&gpio1 5 GPIO_ACTIVE_HIGH>;
		states = <5000000 0x1
			  	  0000000 0x0>;
		
		enable-active-high;
		startup-delay-us = <200>;
	};

	general-5V-switch {
		compatible = "reg-userspace-consumer";
		regulator-name = "general-5V-consumer";
		regulator-supplies = "vdd-5V";
		vdd-5V-supply = <&boost_conv_5V>;
		regulator-boot-on;
	};

	boost_conv_5V_cam: boost_converter_5V_cam {
		compatible = "regulator-gpio";

		regulator-name = "BOOST_CONV_5V_CAM";
		regulator-type = "voltage";
		regulator-min-microvolt = <5000000>;
		regulator-max-microvolt = <5000000>;

		enable-gpios = <&gpio5 26 GPIO_ACTIVE_HIGH>;
		states = <5000000 0x1
			  	  0000000 0x0>;
		
		enable-active-high;
		startup-delay-us = <5000000>; // time for Camera Boot 5s
	};

	camera-switch {
		compatible = "reg-userspace-consumer";
		regulator-name = "camera-consumer";
		regulator-supplies = "vdd-5V-cam";
		vdd-5V-cam-supply = <&boost_conv_5V_cam>;
		regulator-boot-on;
	};

	led_ring_driver: led-ring-driver {
		compatible = "pwm-leds";
		status = "okay";

		ring-1 {
			label = "polarized-led";
			pwms = <&pwm1 0 1000000>;
			max-brightness = <100>;
		};

		ring-2 {
			label = "unpolarized-led";
			pwms = <&pwm2 0 1000000>;
			max-brightness = <100>;
		};
	};

	derma_display_backlight: derma-display-backlight {
		compatible = "pwm-backlight";
		pwms = <&pwm3 0 1000000>;
		status = "okay";

		brightness-levels = < 0  1  2  3  4  5  6  7  8  9
				     10 11 12 13 14 15 16 17 18 19
				     20 21 22 23 24 25 26 27 28 29
				     30 31 32 33 34 35 36 37 38 39
				     40 41 42 43 44 45 46 47 48 49
				     50 51 52 53 54 55 56 57 58 59
				     60 61 62 63 64 65 66 67 68 69
				     70 71 72 73 74 75 76 77 78 79
				     80 81 82 83 84 85 86 87 88 89
				     90 91 92 93 94 95 96 97 98 99
				    100>;
		default-brightness-level = <100>;
	};

	ui_display_backlight: ui-display-backlight {
		compatible = "pwm-backlight";
		pwms = <&pwm4 0 1000000>;
		status = "okay";

		brightness-levels = < 0  1  2  3  4  5  6  7  8  9
				     10 11 12 13 14 15 16 17 18 19
				     20 21 22 23 24 25 26 27 28 29
				     30 31 32 33 34 35 36 37 38 39
				     40 41 42 43 44 45 46 47 48 49
				     50 51 52 53 54 55 56 57 58 59
				     60 61 62 63 64 65 66 67 68 69
				     70 71 72 73 74 75 76 77 78 79
				     80 81 82 83 84 85 86 87 88 89
				     90 91 92 93 94 95 96 97 98 99
				    100>;
		default-brightness-level = <0>;
	};

	lvds_panel: panel-lvds {
		compatible = "sgd,gktw70sdae4se", "panel-lvds"; // maybe only panel-lvds?
		backlight = <&ui_display_backlight>;
		width-mm = <27>;
		height-mm = <68>;
		label = "gktw70sdae4se"; // can we change that?
		data-mapping = "vesa-24";
		status = "okay";

		panel-timing {
			clock-frequency = <30000000>;
			hactive = <376>;
			vactive = <960>;
			hback-porch = <30>;
			hfront-porch = <56>;
			vback-porch = <30>;
			vfront-porch = <60>;
			hsync-len = <10>;
			vsync-len = <10>;
			hsync-active = <0>;
			vsync-active = <0>;
			de-active = <1>;
		};

		port {
			panel_in: endpoint {
				remote-endpoint = <&lvds_out>;
			};
		};
	};

	bat: battery {
		compatible = "simple-battery";
		voltage-min-design-microvolt = <3200000>;
		energy-full-design-microwatt-hours = <15910000>;
		charge-full-design-microamp-hours = <4300000>;
	};
};

// pwm node for led1 ring
&pwm1 {
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_pwm1>;
	status = "okay";
};

// pwm node for led2 ring
&pwm2 {
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_pwm2>;
	status = "okay";
};

// pwm node for mipi derma display backlight
&pwm3 {
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_pwm3>;
	status = "okay";
};

// pwm node for lvds ui display backlight
&pwm4 {
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_pwm4>;
	status = "okay";
};

&i2c2 {
	clock-frequency = <400000>;
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_i2c2>;
	scl-gpios = <&gpio5 16 GPIO_ACTIVE_HIGH>;
	sda-gpios = <&gpio5 17 GPIO_ACTIVE_HIGH>;
	status = "okay";

	touch_ui_display: sitronix_ts@55 {
		compatible = "sitronix,st1633";
		reg = <0x55>;
		pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_ui_disp_captouch>;
		reset-gpios = <&gpio1 10 GPIO_ACTIVE_LOW>;
		interrupt-parent = <&gpio1>;
		interrupts = <11 IRQ_TYPE_EDGE_FALLING>;
		touchscreen-size-x = <376>;
		touchscreen-size-y = <960>;
		wakeup-source;
		status = "okay";
	};
};

&i2c3 {
	clock-frequency = <400000>;
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_i2c3>;
	scl-gpios = <&gpio5 18 GPIO_ACTIVE_HIGH>;
	sda-gpios = <&gpio5 19 GPIO_ACTIVE_HIGH>;
	status = "okay";

	avt_camera_0: avt_camera_0@3c {
		compatible = "alliedvision,avt3"; /*"alliedvision,avt_csi2";*/
		reg = <0x3c>;
		clocks = <&clk IMX8MP_CLK_IPP_DO_CLKO2>;
		clock-names = "csi_mclk";
		assigned-clocks = <&clk IMX8MP_CLK_IPP_DO_CLKO2>;
		assigned-clock-parents = <&clk IMX8MP_CLK_24M>;
		assigned-clock-rates = <24000000>;
		mipi_csi;
		csi_id = <0>;
		mclk = <24000000>;
		mclk_source = <0>;
		
		bcrm_wait_timeout = <5111>; 
		streamon_delay = <80>; 
		x_force_reset_on_init;

		avt-ignore-yuv420_8_leg_avail;
		avt-ignore-yuv420_8_avail;
		avt-ignore-yuv420_10_avail;
		avt-ignore-yuv420_8_csps_avail;
		avt-ignore-yuv420_10_csps_avail;
		x_avt-ignore-yuv422_8_avail;
		avt-ignore-yuv422_10_avail;
		x_avt-ignore-rgb888_avail;
		avt-ignore-rgb666_avail;
		avt-ignore-rgb565_avail;
		avt-ignore-rgb555_avail;
		avt-ignore-rgb444_avail;
		avt-ignore-raw6_avail;
		avt-ignore-raw7_avail;
		x_avt-ignore-raw8_avail;
		x_avt-ignore-raw10_avail;
		x_avt-ignore-raw12_avail;
		avt-ignore-raw14_avail;

		status = "okay";

		port {
			avt_mipi_ep_0: endpoint {
				data-lanes = <0x01 0x02 0x03 0x04>;
				clock-lanes = <0>;
				link-frequencies = /bits/ 64 <681250000>;
				/*max-pixel-frequency = /bits/ 64 <266000000>;*/
				remote-endpoint = <&mipi_csi0_ep>;
			};
		};
	};
};

&i2c5 {
	clock-frequency = <400000>;
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_i2c5>;
	scl-gpios = <&gpio3 26 GPIO_ACTIVE_HIGH>;
	sda-gpios = <&gpio3 27 GPIO_ACTIVE_HIGH>;
	status = "okay";

	touch_derma_display: sitronix_ts@50 {
		compatible = "sitronix,st1633";
		reg = <0x50>;
		pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_derma_disp_captouch>;
		reset-gpios = <&gpio1 7 GPIO_ACTIVE_LOW>;
		interrupt-parent = <&gpio1>;
		interrupts = <8 IRQ_TYPE_EDGE_FALLING>;
		touchscreen-size-x = <480>;
		touchscreen-size-y = <480>;
		wakeup-source;
		status = "okay";
	};
};

&i2c6 {
	clock-frequency = <400000>;
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_i2c6>;
	scl-gpios = <&gpio5 28 GPIO_ACTIVE_HIGH>;
	sda-gpios = <&gpio5 29 GPIO_ACTIVE_HIGH>;
	status = "okay";

	charger@6b {
		compatible = "ti,bq25892";
		reg = <0x6b>;

		pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_charger>;
		interrupt-parent = <&gpio1>;
		interrupts = <12 IRQ_TYPE_EDGE_FALLING>;

		ti,battery-regulation-voltage = <4200000>;
		ti,charge-current = <3200000>;
		ti,termination-current = <50000>;
		ti,precharge-current = <128000>;
		ti,minimum-sys-voltage = <3600000>;
		ti,boost-voltage = <5000000>;
		ti,boost-max-current = <3200000>;
		ti,use-ilim-pin;
		ti,thermal-regulation-threshold = <90>;

		status = "okay";
	};

	bq27427: fuel-gauge@55 {
		compatible = "ti,bq27427";
		reg = <0x55>;
		monitored-battery = <&bat>;
		status = "okay";
	};

	haptics: haptics@5a {
		compatible = "ti,drv2605l";
		reg = <0x5a>;
		vbat-supply = <&boost_conv_5V>;
		pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_haptic>;
		enable-gpio = <&gpio1 1 GPIO_ACTIVE_HIGH>;
		mode = <DRV260X_LRA_MODE>;
		library-sel = <DRV260X_LIB_LRA>;
		vib-rated-mv = <1800>;
		vib-overdrive-mv = <1800>;
		status = "okay";
	};

	rtc: rtc@6f {
		compatible = "microchip,mcp7940x";
		reg = <0x6f>;
		pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_rtc>;
		interrupt-parent = <&gpio1>;
		interrupts = <0 IRQ_TYPE_EDGE_FALLING>;
		status = "okay";
	};

	eeprom: eeprom@50 {
		compatible = "microchip,24c64";
		reg = <0x50>;
		pagesize = <32>;
		status = "okay";
	};
};

/* MIPI-DSI */
&lcdif1 {
	status = "okay";
};

/* LVDS */
&lcdif2 {
	status = "okay";
};

&ldb {
	status = "okay";

	lvds-channel@0 {
		fsl,data-mapping = "spwg";
		fsl,data-width = <24>;
		status = "okay";

		port@1 {
			reg = <1>;

			lvds_out: endpoint {
				remote-endpoint = <&panel_in>;
			};
		};
	};
};

&ldb_phy {
	status = "okay";
};

&mipi_dsi {
	status = "okay";
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_mipi_dsi>;
	mipi_panel: mipi_panel@0 {
		compatible = "techstar,ts8550b", "sitronix,st7701";
		backlight = <&derma_display_backlight>;
		reg = <0>;
		reset-gpios = <&gpio1 6 GPIO_ACTIVE_HIGH>;
		reset-assert-us = <10>;	// Optional
		dsi-lanes = <2>;
		video-mode = <2>;
		/* 0: burst mode
		 * 1: non-burst mode with sync event
		 * 2: non-burst mode with sync pulse
		 */
		panel-width-mm = <70>;
		panel-height-mm = <70>;
		status = "okay";
	};
};

// Console
&uart1 {
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_uart1>;
	status = "okay";
};

&mipi_csi_0 {
	#address-cells = <1>;
	#size-cells = <0>;
	status = "okay";
	clock-frequency = <681250000>;

	port@0 {
		reg = <0>;
		mipi_csi0_ep: endpoint {
			remote-endpoint = <&avt_mipi_ep_0>;
			data-lanes = <4>;
			csis-hs-settle = <14>;
			csis-clk-settle = <2>;
			csis-wclk;
		};
	};
};

&cameradev {
	status = "okay";
};

&isi_0 {
	status = "okay";
	//interface = <3 0 2>; Fuer den Fall CSI2->ISI1
	cap_device {
		status = "okay";
	};

	m2m_device {
		status = "okay";
	};
};

&isi_1 {
	status = "okay";
	//interface = <2 0 2>; Fuer den Fall CSI1->ISI2
	cap_device {
		status = "okay";
	};
};

/* audio codec */
&wm8904 {
	status = "disabled";
};

/* synchronous audio interface */
&sai3 {
	status = "disabled";
};

/* ethernet (quality of service features)  */
&eqos {
	status = "disabled";
};

&iomuxc {
	// LED ring 1
	pinctrl_pwm1: pwm1grp {
		fsl,pins = <
			MX8MP_IOMUXC_I2C4_SDA__PWM1_OUT						0x116
		>;
	};

	// LED ring 2
	pinctrl_pwm2: pwm2grp {
		fsl,pins = <
			MX8MP_IOMUXC_I2C4_SCL__PWM2_OUT						0x116
		>;
	};

	// Backlight mipi derma display
	pinctrl_pwm3: pwm3grp {
		fsl,pins = <
			MX8MP_IOMUXC_SPDIF_TX__PWM3_OUT						0x116
		>;
	};

	// Backlight lvds ui display
	pinctrl_pwm4: pwm4grp {
		fsl,pins = <
			MX8MP_IOMUXC_GPIO1_IO15__PWM4_OUT					0x116
		>;
	};

	pinctrl_i2c2: i2c2grp {
		fsl,pins = <
			MX8MP_IOMUXC_I2C2_SCL__I2C2_SCL					0x400000a2
			MX8MP_IOMUXC_I2C2_SDA__I2C2_SDA					0x400001c2
		>;
	};

	pinctrl_i2c3: i2c3grp {
		fsl,pins = <
			MX8MP_IOMUXC_I2C3_SCL__I2C3_SCL					0x400000a2
			MX8MP_IOMUXC_I2C3_SDA__I2C3_SDA					0x400001c2
		>;
	};
	
	pinctrl_i2c5: i2c5grp {
		fsl,pins = <	
			MX8MP_IOMUXC_HDMI_DDC_SCL__I2C5_SCL				0x400000a2
			MX8MP_IOMUXC_HDMI_DDC_SDA__I2C5_SDA				0x400001c2
		>;
	};
	
	pinctrl_i2c6: i2c6grp {
		fsl,pins = <
			MX8MP_IOMUXC_UART4_RXD__I2C6_SCL				0x400000a2
			MX8MP_IOMUXC_UART4_TXD__I2C6_SDA				0x400001c2
		>;
	};

	/*
	 * GPIO1_IO12 - CHG_INT - Slew rate = fast
	 * GPIO1_IO13 - CHG_OTG - Pull-down; Slew rate = fast
	 * GPIO1_IO14 - CHG_/CE - Pull-down; Slew rate = fast
	 * GPIO4_IO23 - CHG_PSEL- Pull-up; Slew rate = fast
	 */
	pinctrl_charger: chargergrp {
		fsl,pins = <
			MX8MP_IOMUXC_GPIO1_IO12__GPIO1_IO12				0x00000010
			MX8MP_IOMUXC_GPIO1_IO13__GPIO1_IO13				0x00000110
			MX8MP_IOMUXC_GPIO1_IO14__GPIO1_IO14				0x00000110
			MX8MP_IOMUXC_SAI2_RXD0__GPIO4_IO23				0x00000150
		>;
	};

	/*
	 * GPIO1_IO10 - Reset - Drive strength = X6; Slew rate = fast; Pull-up
	 * GPIO1_IO11 - Int	  - Drive strength = X6; Slew rate = fast
	 */
	pinctrl_ui_disp_captouch: ui_disp_captouchgrp {
		fsl,pins = <
			MX8MP_IOMUXC_GPIO1_IO10__GPIO1_IO10				0x00000156
			MX8MP_IOMUXC_GPIO1_IO11__GPIO1_IO11				0x00000016
		>;
	};

	/*
	 * GPIO1_IO07 - Reset - Drive strength = X6; Slew rate = fast; Pull-up
	 * GPIO1_IO08 - Int	  - Drive strength = X6; Slew rate = fast
	 */
	pinctrl_derma_disp_captouch: derma_disp_captouchgrp {
		fsl,pins = <
			MX8MP_IOMUXC_GPIO1_IO07__GPIO1_IO07				0x00000156
			MX8MP_IOMUXC_GPIO1_IO08__GPIO1_IO08				0x00000016
		>;
	};

	/* 
	 * GPIO1_IO06 - Reset - Drive strength = X6; Slew rate = fast
	 */ 
	pinctrl_mipi_dsi: mipigrp {		
		fsl,pins = <
			MX8MP_IOMUXC_GPIO1_IO06__GPIO1_IO06 				0x16
		>;
	};

	pinctrl_haptic: hapticgrp {
		fsl,pins = <
			MX8MP_IOMUXC_GPIO1_IO01__GPIO1_IO01 				0x16
		>;
	};

	pinctrl_rtc: rtcgrp {
		fsl,pins = <
			MX8MP_IOMUXC_GPIO1_IO00__GPIO1_IO00 				0x16
		>;
	};

	pinctrl_uart1: uart1grp {
		fsl,pins = <
			MX8MP_IOMUXC_UART1_RXD__UART1_DCE_RX				0x40
			MX8MP_IOMUXC_UART1_TXD__UART1_DCE_TX				0x40
		>;
	};

	pinctrl_uart4: uart4grp {
		fsl,pins = <
			MX8MP_IOMUXC_ECSPI2_SCLK__UART4_DCE_RX				0x140
			MX8MP_IOMUXC_ECSPI2_MOSI__UART4_DCE_TX				0x140
			MX8MP_IOMUXC_ECSPI2_MISO__UART4_DCE_CTS				0x140
			MX8MP_IOMUXC_ECSPI2_SS0__UART4_DCE_RTS				0x140
		>;
	};
};
